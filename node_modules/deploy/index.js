/**
 * fis.baidu.com
 */
var _ = require('./fis-util');

function upload(receiver, to, subpath, content, callback) {

  _.upload(
    //url, request options, post data, file
    receiver, null, {
      to: to + subpath
    }, content, subpath,
    function(err, res) {
      if (err || res.trim() != '0') {
        callback('upload file [' + subpath + '] to [' + to +
          '] by receiver [' + receiver + '] error [' + (err || res) + ']');
      } else {
        var time = '[' + Date.now() + ']';
        process.stdout.write(
          ' - '.green.bold +
          time.grey + ' ' +
          subpath.replace(/^\//, '') +
          ' >> '.yellow.bold +
          to + subpath +
          '\n'
        );
        callback();
      }
    }
  );
}

module.exports = function(root, path, callback) {
  // options, modified, total, callback
  

  var to = "/";
  var receiver = "http://127.0.0.1:8999/receiver";
  var subpath = path.substr(root.length);
  var content = _.read(path);

  var steps = [];

    var reTryCount = 2;

  steps.push(function(next) {
    var _upload = arguments.callee;

    upload(receiver, to, subpath, content, function(error) {
      if (error) {
        if (!--reTryCount) {
          throw new Error(error);
        } else {
          _upload();
        }
      } else {
        next && next();
      }
    });
  });


  _.reduceRight(steps, function(next, current) {
    return function() {
      current(next);
    };
  }, callback)();
};

module.exports.options = {
  // 允许重试两次。
  retry: 2
};
